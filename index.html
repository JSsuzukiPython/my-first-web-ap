import React, { useState, useEffect, useRef } from 'react';
import { Timer, CheckCircle, BookOpen, MessageSquare, Play, Pause, RotateCcw, Plus, Trash2, Send, Loader2 } from 'lucide-react';

const API_KEY = ""; // 実行環境から提供されます

const App = () => {
  // --- 状態管理 ---
  const [activeTab, setActiveTab] = useState('timer');
  const [tasks, setTasks] = useState([]);
  const [newTask, setNewTask] = useState('');
  
  // タイマー関連
  const [timeLeft, setTimeLeft] = useState(25 * 60);
  const [isActive, setIsActive] = useState(false);
  const [mode, setMode] = useState('work'); // 'work' or 'break'

  // AIチャット関連
  const [messages, setMessages] = useState([
    { role: 'assistant', text: 'こんにちは！学習のアドバイスが必要ですか？例えば「効果的な復習のタイミングは？」や「今日の学習計画を立てるのを手伝って」など、何でも聞いてくださいね。' }
  ]);
  const [inputMessage, setInputMessage] = useState('');
  const [isTyping, setIsTyping] = useState(false);

  // --- タイマーロジック ---
  useEffect(() => {
    let interval = null;
    if (isActive && timeLeft > 0) {
      interval = setInterval(() => {
        setTimeLeft((prev) => prev - 1);
      }, 1000);
    } else if (timeLeft === 0) {
      clearInterval(interval);
      handleTimerComplete();
    } else {
      clearInterval(interval);
    }
    return () => clearInterval(interval);
  }, [isActive, timeLeft]);

  const handleTimerComplete = () => {
    setIsActive(false);
    if (mode === 'work') {
      setMode('break');
      setTimeLeft(5 * 60);
      alert('作業時間終了！5分間の休憩を取りましょう。');
    } else {
      setMode('work');
      setTimeLeft(25 * 60);
      alert('休憩終了！次のセッションを始めましょう。');
    }
  };

  const toggleTimer = () => setIsActive(!isActive);
  const resetTimer = () => {
    setIsActive(false);
    setTimeLeft(mode === 'work' ? 25 * 60 : 5 * 60);
  };

  const formatTime = (seconds) => {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
  };

  // --- タスク管理ロジック ---
  const addTask = (e) => {
    e.preventDefault();
    if (!newTask.trim()) return;
    setTasks([...tasks, { id: Date.now(), text: newTask, completed: false }]);
    setNewTask('');
  };

  const toggleTask = (id) => {
    setTasks(tasks.map(t => t.id === id ? { ...t, completed: !t.completed } : t));
  };

  const deleteTask = (id) => {
    setTasks(tasks.filter(t => t.id !== id));
  };

  // --- AI相談ロジック ---
  const sendMessage = async (e) => {
    e.preventDefault();
    if (!inputMessage.trim() || isTyping) return;

    const userMsg = inputMessage;
    setInputMessage('');
    setMessages(prev => [...prev, { role: 'user', text: userMsg }]);
    setIsTyping(true);

    try {
      const response = await fetchWithRetry(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: userMsg }] }],
            systemInstruction: { parts: [{ text: "あなたはプロの学習アドバイザーです。中高生や大学生が効率的に勉強できるよう、優しく、具体的なアドバイスを提供してください。回答は簡潔に、箇条書きなどを活用して読みやすくしてください。" }] }
          })
        }
      );

      const data = await response.json();
      const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "すみません、少し考えがまとまりませんでした。もう一度聞いていただけますか？";
      setMessages(prev => [...prev, { role: 'assistant', text: aiResponse }]);
    } catch (error) {
      setMessages(prev => [...prev, { role: 'assistant', text: "エラーが発生しました。接続を確認してください。" }]);
    } finally {
      setIsTyping(false);
    }
  };

  const fetchWithRetry = async (url, options, retries = 5, backoff = 1000) => {
    try {
      const res = await fetch(url, options);
      if (!res.ok) throw new Error();
      return res;
    } catch (err) {
      if (retries <= 0) throw err;
      await new Promise(resolve => setTimeout(resolve, backoff));
      return fetchWithRetry(url, options, retries - 1, backoff * 2);
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans">
      {/* Navigation */}
      <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around p-4 z-50">
        <button onClick={() => setActiveTab('timer')} className={`flex flex-col items-center ${activeTab === 'timer' ? 'text-blue-600' : 'text-slate-400'}`}>
          <Timer size={24} />
          <span className="text-xs mt-1">タイマー</span>
        </button>
        <button onClick={() => setActiveTab('tasks')} className={`flex flex-col items-center ${activeTab === 'tasks' ? 'text-blue-600' : 'text-slate-400'}`}>
          <CheckCircle size={24} />
          <span className="text-xs mt-1">タスク</span>
        </button>
        <button onClick={() => setActiveTab('chat')} className={`flex flex-col items-center ${activeTab === 'chat' ? 'text-blue-600' : 'text-slate-400'}`}>
          <MessageSquare size={24} />
          <span className="text-xs mt-1">AI相談</span>
        </button>
      </nav>

      {/* Main Content */}
      <main className="pb-24 pt-8 px-4 max-w-md mx-auto">
        {activeTab === 'timer' && (
          <div className="flex flex-col items-center space-y-8 animate-in fade-in duration-500">
            <h1 className="text-2xl font-bold text-slate-800">集中タイム</h1>
            <div className={`w-64 h-64 rounded-full border-8 flex flex-col items-center justify-center bg-white shadow-xl transition-colors duration-500 ${mode === 'work' ? 'border-blue-500' : 'border-green-500'}`}>
              <span className="text-5xl font-mono font-bold">{formatTime(timeLeft)}</span>
              <span className="text-sm text-slate-500 mt-2">{mode === 'work' ? '集中中' : '休憩中'}</span>
            </div>
            
            <div className="flex space-x-4">
              <button onClick={toggleTimer} className={`p-4 rounded-full text-white shadow-lg transition-transform active:scale-95 ${isActive ? 'bg-orange-500' : 'bg-blue-600'}`}>
                {isActive ? <Pause size={32} /> : <Play size={32} className="ml-1" />}
              </button>
              <button onClick={resetTimer} className="p-4 rounded-full bg-slate-200 text-slate-600 shadow-md active:scale-95">
                <RotateCcw size={32} />
              </button>
            </div>
          </div>
        )}

        {activeTab === 'tasks' && (
          <div className="space-y-6 animate-in slide-in-from-right duration-300">
            <h1 className="text-2xl font-bold text-slate-800">今日の学習タスク</h1>
            <form onSubmit={addTask} className="flex space-x-2">
              <input
                type="text"
                value={newTask}
                onChange={(e) => setNewTask(e.target.value)}
                placeholder="例: 数学のワーク3ページ"
                className="flex-1 p-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <button type="submit" className="bg-blue-600 text-white p-3 rounded-xl hover:bg-blue-700">
                <Plus size={24} />
              </button>
            </form>

            <div className="space-y-3">
              {tasks.length === 0 ? (
                <div className="text-center py-12 text-slate-400">
                  <BookOpen size={48} className="mx-auto mb-4 opacity-20" />
                  <p>タスクを追加して学習を始めよう！</p>
                </div>
              ) : (
                tasks.map(task => (
                  <div key={task.id} className="flex items-center bg-white p-4 rounded-xl shadow-sm border border-slate-100 group">
                    <button 
                      onClick={() => toggleTask(task.id)}
                      className={`w-6 h-6 rounded-md border-2 mr-3 flex items-center justify-center transition-colors ${task.completed ? 'bg-green-500 border-green-500' : 'border-slate-300'}`}
                    >
                      {task.completed && <CheckCircle size={16} className="text-white" />}
                    </button>
                    <span className={`flex-1 ${task.completed ? 'line-through text-slate-400' : 'text-slate-700'}`}>
                      {task.text}
                    </span>
                    <button onClick={() => deleteTask(task.id)} className="text-slate-300 hover:text-red-500 transition-colors">
                      <Trash2 size={20} />
                    </button>
                  </div>
                ))
              )}
            </div>
          </div>
        )}

        {activeTab === 'chat' && (
          <div className="flex flex-col h-[calc(100vh-10rem)] animate-in slide-in-from-right duration-300">
            <h1 className="text-2xl font-bold text-slate-800 mb-4">AI学習相談</h1>
            <div className="flex-1 overflow-y-auto space-y-4 mb-4 pr-2 scrollbar-hide">
              {messages.map((msg, i) => (
                <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                  <div className={`max-w-[85%] p-3 rounded-2xl ${msg.role === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white text-slate-700 shadow-sm border border-slate-100 rounded-bl-none'}`}>
                    <p className="text-sm whitespace-pre-wrap">{msg.text}</p>
                  </div>
                </div>
              ))}
              {isTyping && (
                <div className="flex justify-start">
                  <div className="bg-white p-3 rounded-2xl shadow-sm border border-slate-100 flex items-center space-x-2">
                    <Loader2 size={16} className="animate-spin text-blue-600" />
                    <span className="text-xs text-slate-400">AIが考えています...</span>
                  </div>
                </div>
              )}
            </div>
            <form onSubmit={sendMessage} className="flex space-x-2 bg-white p-2 rounded-2xl shadow-inner border border-slate-200">
              <input
                type="text"
                value={inputMessage}
                onChange={(e) => setInputMessage(e.target.value)}
                placeholder="メッセージを入力..."
                className="flex-1 p-2 bg-transparent focus:outline-none text-sm"
              />
              <button disabled={isTyping} type="submit" className="bg-blue-600 text-white p-2 rounded-xl disabled:opacity-50">
                <Send size={20} />
              </button>
            </form>
          </div>
        )}
      </main>
    </div>
  );
};

export default App;
